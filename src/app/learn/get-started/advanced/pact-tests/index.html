<stache
pageTitle="Pact Testing"
navTitle="Pact testing"
showTableOfContents="true">

  <stache-page-summary>
    <p>
      Pact is a testing framework that supports Consumer-Driven Contract Testing between dependent systems where the integration is based on HTTP. It uses contracts between interdependent services that are designed from the perspective of the consumer. We recommend creating pact tests for all services that a SPA consumes to confirm that the SPA can call the services and that the providers can call the SPA. This topic describes how to configure your SPA for pact testing, write pact tests, and run tests with the <stache-code>skyux pact</stache-code> command.
    </p>
  </stache-page-summary>

  <stache-page-anchor>
    Configure pact settings
  </stache-page-anchor>
  
  <p>
    The first step to implement pact testing for a SPA is to specify configuration options in <a routerLink="/learn/reference/configuration">the <stache-code>skyuxconfig.json</stache-code> file</a> with the <stache-code>pacts</stache-code> property. In this property, you create a separate entry for each provider to test. Settings are generally the same for each entry except that the <stache-code>provider</stache-code> value is different. When you run <stache-code>skyux pact</stache-code>, the command reads the <stache-code>pacts</stache-code> setting and spins up an individual pact server for each provider service that you specify.
  </p>
  <p>
    For each service provider that you need to configure settings for, you can include the following properties: 
  </p>
  <ul>
    <li>
      <p>
        To specify the consumer and provider of a service, add the <stache-code>consumer</stache-code> and <stache-code>provider</stache-code> settings. The provider is the service that exposes an API, while the consumer is the component or service in the SPA that calls the provider's API.
      </p>
      <stache-code-block>
        {
          "pacts": [
            {
              "consumer": "{consumer}",
              "provider": "{provider}"
            }
          ]
        }
      </stache-code-block>
    </li>
    <li>
      <p>
        To specify a host and port to use for pact tests, add the <stache-code>host</stache-code> and <stache-code>port</stache-code> settings. By default, the host is <stache-code>localhost</stache-code> and SKY UX Builder dynamically finds the next available port.
      </p>
      <stache-code-block>
        {
          "pacts": [
            {
              "consumer": "{consumer}",
              "provider": "{provider}"
              "host": "{host}",
              "port": "{port}"
            }
          ]
        }
      </stache-code-block>
    </li>
    <li>
      <p>
        Configure the log file as necessary:
      </p>
      <ul>
        <li>
          <p>
            To specify a name for the log file, add the <stache-code>log</stache-code> setting. By default, the name is <stache-code>pact-&#123;provider}.log</stache-code>.
          </p>
        </li>
        <li>
          <p>
            To specify a location for the log file, add the <stache-code>dir</stache-code> setting. By default, the file is placed in the <stache-code>app/pacts</stache-code> directory.</p>
        </li>
        <li>
          <p>
            To specify XXXXXXX for the log file, add the <stache-code>logLevel</stache-code> setting. By default, the XXXXXX is <stache-code>XXXXXXX</stache-code>.</p>
        </li>
        <li>
          <p>
            To specify XXXXXXX for the log file, add the <stache-code>spec</stache-code> setting. By default, the XXXXX is <stache-code>2</stache-code>.
          </p>
        </li>
      </ul>
      <stache-code-block>
        {
          "pacts": [
            {
              "consumer": "{consumer}",
              "provider": "{provider}",
              "host": "{host}",
              "port": "{port}",
              "log": "{name}",
              "dir": "{directory}",
              "logLevel": "{XXXXXX}",
              "spec": "{XXXXX}"
            }
          ]
        }
        </stache-code-block>
    </li>
  </ul>

  <h3>
    Override the provider URL
  </h3>

  <p>
    After you create an entry for the provider in <a routerLink="/learn/reference/configuration">the <stache-code>skyuxconfig.json</stache-code> file</a>, you need to override the provider URL to be <stache-code>SkyAppConfig.runtime.pactConfig.pactProxyServer/&#123;provider}</stache-code>. A proxy redirects this URL to the proper pact server. To fufill CORS, the proxy server sets the <stache-code>Origin</stache-code> header to the <stache-code>url</stache-code> value that the <stache-code>host</stache-code> property defines in <stache-code>skyuxconfig.json</stache-code>. The <stache-code>url</stache-code> setting specifies a base URL to pass information from <stache-code>skyux serve</stache-code> to the SKY UX Host, and the default value is <stache-code>https://host.nxt.blackbaud.com</stache-code>.
  </p>

  <stache-page-anchor>
    Write pact tests
  </stache-page-anchor>

  <p>
    After you configure settings for a provider, your next step is to create pact tests to confirm integration between the provider services and your SPA. We recommend creating pact tests for all services that your SPA consumes.
  </p>

  <ul>
    <li>
      <p>
        To create the pact test, add a new file with a filename that ends with <stache-code>.pact-spec.ts</stache-code>. SKY UX automatically configures Karma to run pact tests in the <stache-code>src/app</stache-code> folder that match the <stache-code>.pact-spec.ts</stache-code> pattern. We recommend that SKY UX pact tests use the same name as the components or services where they test integration with consumed services and that you place the spec files in the same folder as the components or services that they test. 
      </p>
    </li>
    <li>
      <p>
        Pact tests must include a <stache-code>beforeAll</stache-code> block. Within the <stache-code>beforeAll</stache-code> block, import <stache-code>SkyAppTestModule</stache-code> and provide access to <stache-code>SkyPactService</stache-code>.
      </p>
      <stache-code-block>
        TestBed.configureTestingModule({
          imports: [SkyAppTestModule]
          });
          skyPactService = TestBed.get(SkyPactService);
      </stache-code-block>
      <p>
        With the <stache-code>beforeAll</stache-code> block in place, you can call <stache-code>skyPactService.addInteraction(&#123;provider-name-here}, &#123;})</stache-code>.</p>
      <p>
        Similarly for all the other functions, the name of the provider must be passed in as a parameter.
      </p>
    </li>
    <li>
      <p>
        The <stache-code>SkyPactService</stache-code> includes the following methods:
      </p>
      <ul>
        <li>
          <p>
            <stache-code>addInteraction</stache-code>
          </p>
          <p>
            Call the <stache-code>addInteraction</stache-code> method with an input similar to this:
          </p>
          <stache-code-block>
            {
              uponReceiving: '{description}',
              state: `{provider_state}`,
              withRequest: {
                method: 'get',
                path: '/api/path',
                headers: {
                  'Origin': 'https://host.nxt.blackbaud.com (or whatever your SPA domain is)
                }
              },
              willRespondWith: {
                status: 200,
                headers: {
                  'Content-Type': {expected content type},
                  'Access-Control-Allow-Origin': 'host.nxt.blackbaud.com' (or whatever your SPA domain is)
                }
              }
            }
          </stache-code-block>
        </li>
        <li>
          <p>
            <stache-code>removeInteractions</stache-code>
          </p>
        </li>
        <li>
          <p>
            <stache-code>finalize</stache-code>
          </p>
        </li>
        <li>
          <p>
            <stache-code>verify</stache-code>
          </p>
        </li>
      </ul>
    </li>
  </ul>

  <stache-page-anchor>
    Run pact tests
  </stache-page-anchor>

  <p>
    After you create your pact tests, your next step is to use the SKY UX CLI to run the tests and confirm integration between the provider services and your SPA. you can use the <stache-code>skyux pact</stache-code> command to run your pact tests.
  </p>
  <p>
    From the command prompt, navigate to your SPA's directory and run <a routerLink="/learn/reference/cli-commands/pact">the <stache-code>skyux pact</stache-code> command</a>.
  </p>
  <p>
    SKY UX automatically configures Karma to run all pact tests in the <stache-code>src/app</stache-code> folder that match the <stache-code>.pact-spec.ts</stache-code> pattern. The <stache-code>pact</stache-code> command spins up a pact server for each test and also spins up a pact server for the proxy server. The proxy server takes requests from the browser that runs in the host and port specified in your configuration settings, and it changes the CORS headers to the <stache-code>host</stache-code> property's <stache-code>url</stache-code> value in <stache-code>skyuxconfig.json</stache-code>, which defaults to <stache-code>https://host.nxt.blackbaud.com</stache-code>. 
  </p>

</stache>
