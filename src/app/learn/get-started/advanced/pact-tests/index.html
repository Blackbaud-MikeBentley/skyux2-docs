<stache
pageTitle="Pact Testing"
navTitle="Pact testing"
showTableOfContents="true">

  <stache-page-summary>
    <p>
      Pact is a testing framework that supports Consumer-Driven Contract Testing between dependent systems where the integration is based on HTTP. It uses contracts between interdependent services that are designed from the perspective of the consumer. We recommend creating pact tests for all services that a SPA consumes to confirm that the SPA can call out to the provider services and vice versa. This topic describes how to configure the SPA for pact testing, write pact tests, and run tests with the <stache-code>skyux pact</stache-code> command.
    </p>
  </stache-page-summary>

  <stache-page-anchor>
    Configure pact settings
  </stache-page-anchor>
  
  <p>
    The first step to implement pact testing for a SPA is to specify configuration options in <a routerLink="/learn/reference/configuration">the <stache-code>skyuxconfig.json</stache-code> file</a> within the <stache-code>pacts</stache-code> property. In this property, you create a separate entry for each provider to test. Settings are generally the same for each entry except that the <stache-code>provider</stache-code> value is different. When you run <stache-code>skyux pact</stache-code>, the command reads the <stache-code>pacts</stache-code> setting and spins up an individual pact server for each provider service that you specify.
  </p>
  <p>
    For each service provider that you need to configure settings for, you can include the following properties: 
  </p>
  <ul>
    <li>
      <p>
        To specify the consumer and provider of a service, add the <stache-code>consumer</stache-code> and <stache-code>provider</stache-code> settings. The provider is the service that exposes an API, while the consumer is the SPA component or service that calls the provider's API.
      </p>
      <stache-code-block>
        {
          "pacts": [
            {
              "consumer": "{consumer}",
              "provider": "{provider}"
            }
          ]
        }
      </stache-code-block>
    </li>
    <li>
      <p>
        To specify a host and port to use for pact tests, add the <stache-code>host</stache-code> and <stache-code>port</stache-code> settings. By default, the host is <stache-code>localhost</stache-code> and SKY UX Builder dynamically finds the next available port.
      </p>
      <stache-code-block>
        {
          "pacts": [
            {
              "consumer": "{consumer}",
              "provider": "{provider}"
              "host": "{host}",
              "port": "{port}"
            }
          ]
        }
      </stache-code-block>
    </li>
    <li>
      <p>
        You can configure several properties for the log file:
      </p>
      <ul>
        <li>
          <p>
            To specify a name for the log file, add the <stache-code>log</stache-code> setting. By default, the name is <stache-code>pact-&#123;provider}.log</stache-code>.
          </p>
        </li>
        <li>
          <p>
            To specify a location for the log file, add the <stache-code>dir</stache-code> setting. By default, the file is placed in the <stache-code>app/pacts</stache-code> directory.</p>
        </li>
        <li>
          <p>
            To specify XXXXXXX for the log file, add the <stache-code>logLevel</stache-code> setting. By default, the XXXXXX is <stache-code>XXXXXXX</stache-code>.</p>
        </li>
        <li>
          <p>
            To specify XXXXXXX for the log file, add the <stache-code>spec</stache-code> setting. By default, the XXXXX is <stache-code>2</stache-code>.
          </p>
        </li>
      </ul>
      <stache-code-block>
        {
          "pacts": [
            {
              "consumer": "{consumer}",
              "provider": "{provider}",
              "host": "{host}",
              "port": "{port}",
              "log": "{name}",
              "dir": "{directory}",
              "logLevel": "{XXXXXX}",
              "spec": "{XXXXX}"
            }
          ]
        }
        </stache-code-block>
    </li>
  </ul>

  <h3>
    Override the provider URL
  </h3>

  <p>
    After you create an entry for the provider in <a routerLink="/learn/reference/configuration">the <stache-code>skyuxconfig.json</stache-code> file</a>, you need to override the provider URL to be <stache-code>SkyAppConfig.runtime.pactConfig.pactProxyServer/&#123;provider}</stache-code>. A proxy will redirect this URL to the proper pact server. To fufill CORS, the proxy server sets the <stache-code>Origin</stache-code> header to the value that you define in the config under host.url. Otherwise, it defaults to <stache-code>https://host.nxt.blackbaud.com</stache-code>.
  </p>
  <p>
    After you set up configuration settings, it's time to create pact tests to confirm integration with the services that the SPA consumes. We recommend creating pact tests for all provider services.
  </p>

  <stache-page-anchor>
    Write pact tests
  </stache-page-anchor>

  <p>
    To create a pact test, add a new file and end the filename with <stache-code>.pact-spec.ts</stache-code>.
  </p>
  <p>
    <strong>****My notes from Josh don't include anything else about how to name the file or where to place it. Need to add that here and also in the File conventions reference topic. Probably also need to add something about e2e vs unit tests.****</strong>
  </p>
<p>
  Pact tests must include a <stache-code>beforeAll</stache-code> block.
</p>
<stache-code-block>
    TestBed.configureTestingModule({
      imports: [SkyAppTestModule]
    });
</stache-code-block>
<p>The <stache-code>SkyPactService</stache-code> must include the following methods:</p>
<ul>
  <li>
    <p>
      addInteraction
    </p>
  </li>
  <li>
    <p>
      removeInteractions
    </p>
  </li>
  <li>
    <p>
      finalize
    </p>
  </li>
  <li>
    <p>
      verify
    </p>
  </li>
  </ul>
  <p>
    <strong>****This is all I have in my notes, but it seems like we should have a description for these methods and any instructions to highlight.****</strong>
  </p>
    <p>
    <strong>****Should we have a separate section about the SkyPactService? Seems to me like that's a separate piece, but the notes Josh provided jsut called it out as part of writing the test. Separate step?****</strong>
  </p>
  <p>Call the <stache-code>addInteraction</stache-code> method with an input similar to this:</p>
  <stache-code-block>
    {
      uponReceiving: '{description}',
      state: `{provider_state}`,
      withRequest: {
        method: 'get',
        path: '/api/path',
        headers: {
          'Origin': 'https://host.nxt.blackbaud.com (or whatever your SPA domain is)
        }
      },
      willRespondWith: {
        status: 200,
        headers: {
          'Content-Type': {expected content type},
          'Access-Control-Allow-Origin': 'host.nxt.blackbaud.com' (or whatever your SPA domain is)
        }
      }
    }
  </stache-code-block>
  <p>
     After your pact tests are in place, you can run the <stache-code>skyux pact</stache-code> command to run your pact tests.
  </p>

  <stache-page-anchor>
    Run pact tests
  </stache-page-anchor>

  <p>
    To run pact tests after you configure pact settings for your SPA and create the tests, open the command prompt from your SPA's directory and enter <stache-code>skyux pact</stache-code>.
  </p>
  <p>
    SKY UX automatically configures Karma to run all pact tests in the <stache-code>src/app</stache-code> folder that match the <stache-code>.pact-spec.ts</stache-code> pattern. The command spins up a pact server for each test and also spins up a pact server for the proxy server. The proxy server takes requests from the browser that runs in the host and port specified in the configuration settings, and it also changes the CORS headers to the values that you define in the config under host.url or to the default of <stache-code>https://host.nxt.blackbaud.com</stache-code>. 
  </p>



So as far as the details I meant to send you.  
```    TestBed.configureTestingModule({
      imports: [SkyAppTestModule]
    });
    skyPactService = TestBed.get(SkyPactService);
```
This is basically what they'll need to do to get access to the service.  From there al they'll need to do is call `skyPactService.addInteraction({provider-name-here}, {})`.  Similarly for all the other functions, the name of the provider will need to be passed in as a parameter.  The format of the interaction object when calling `addInteraction` can be found in the pact docs


  <stache-page-anchor>
    Placeholder
  </stache-page-anchor>

  <p>
    placeholder section to plug in if I missed anything
  </p>
  <stache-code-block>
    placeholder
    placeholder
  </stache-code-block>

</stache>
